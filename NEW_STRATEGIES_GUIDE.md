# 新增策略使用指南

**版本**: V2.0 - 6策略系统
**日期**: 2025-12-03

---

## 概述

在原有3个策略的基础上，新增了3个更适合日本市场特点的策略，形成6策略组合系统。

### 原有策略 (3个)
1. **做市策略 (MarketMaking)** - 15%权重
2. **流动性抢占 (LiquidityTaker)** - 15%权重
3. **订单流策略 (OrderFlow)** - 10%权重

### ✅ 新增策略 (3个)
4. **微网格震荡剥头皮 (MicroGrid)** - 25%权重 ⭐
5. **短周期动量跟随 (ShortMomentum)** - 20%权重
6. **盘口统计订单流 (TapeReading)** - 15%权重

---

## 策略1: 微网格震荡剥头皮 (MicroGrid) ⭐推荐

### 核心思路
在震荡市场中设置密集网格，低买高卖，吃1-5个tick的小利润。

### 适用场景
- **震荡市**: 价格在区间内反复波动
- **波动率<0.3%**: 低波动环境
- **高流动性**: 买卖价差小

### 关键参数
```python
MicroGridConfig(
    grid_spacing_ticks=2,           # 网格间距2 ticks (0.2日元)
    grid_levels=5,                  # 上下各5档网格
    grid_profit_target_ticks=2,     # 每格利润2 ticks

    range_volatility_threshold=0.003,  # 波动率<0.3%确认震荡
    max_position=300,                   # 最大300股 (多网格)
)
```

### 工作流程
1. **检测震荡区间** (60秒窗口)
   - 计算价格波动率
   - 识别支撑/阻力位
   - 确定区间上下界

2. **布设网格**
   ```
   例如: 价格区间 [995 - 1005]

   网格档位:
   Level +5: Buy@1005.0 → Sell@1005.2
   Level +4: Buy@1003.0 → Sell@1003.2
   Level +3: Buy@1001.0 → Sell@1001.2
   Level +2: Buy@999.0 → Sell@999.2
   Level +1: Buy@997.0 → Sell@997.2
   Level 0:  Buy@995.0 → Sell@995.2  (中心)
   Level -1: Buy@993.0 → Sell@993.2
   ...
   ```

3. **执行交易**
   - 价格触碰网格买入价 → 开仓
   - 价格上涨至网格卖出价 → 止盈
   - 可同时持有多个网格

4. **风险控制**
   - 脱离震荡区间 → 全部清仓
   - 单档最大100股
   - 总仓位最大300股

### 盈利逻辑
```
交易次数: 100次/天
平均利润: 2 ticks = 0.2日元/股
持仓: 100股/次
手续费: 0.01% ≈ 0.1日元/股来回

盈利 = (0.2 - 0.1) × 100股 × 100次
     = 10日元 × 100
     = 1,000日元/天
```

### 优势
✅ 适合日本市场 (60%时间震荡)
✅ 风险可控 (区间内交易)
✅ 不依赖方向判断
✅ 频繁交易，积少成多

### 风险
⚠️ 趋势市亏损 (单边突破区间)
⚠️ 手续费侵蚀利润
⚠️ 需要高流动性

---

## 策略2: 短周期动量跟随 (ShortMomentum)

### 核心思路
基于1-5秒K线和microVWAP，捕捉短期趋势。

### 适用场景
- **趋势市**: 明确的价格方向
- **高成交量**: 突破确认
- **EMA金叉/死叉**: 技术信号清晰

### 关键参数
```python
ShortMomentumConfig(
    bar_period_seconds=3,           # 3秒K线
    fast_ema_periods=3,             # 快线3周期
    slow_ema_periods=8,             # 慢线8周期

    momentum_min_ticks=2,           # 最小动量2 ticks
    vwap_deviation_threshold=0.0015, # VWAP偏离0.15%

    time_stop_seconds=30,           # 30秒时间止损
)
```

### 工作流程
1. **构建K线** (3秒周期)
   ```
   Bar 1: O=1000.0, H=1000.5, L=999.8, C=1000.3
   Bar 2: O=1000.3, H=1000.8, L=1000.1, C=1000.7
   Bar 3: O=1000.7, H=1001.2, L=1000.5, C=1001.0
   ...
   ```

2. **计算指标**
   - Fast EMA(3): 基于最近3根K线收盘价
   - Slow EMA(8): 基于最近8根K线收盘价
   - microVWAP: 10秒内成交量加权价格
   - Momentum: 5秒内价格变化

3. **入场信号**

   **做多**:
   ```
   1. 快线上穿慢线 (EMA差距≥0.5 ticks)
   2. 价格>microVWAP (偏离≥0.15%)
   3. 正动量 (≥2 ticks)
   ```

   **做空**: (相反)

4. **出场机制**
   - 动态止盈: 盈利≥3 ticks后回撤1.5 ticks
   - 时间止损: 持仓30秒强制平仓

### 盈利逻辑
```
捕捉每次3-5秒的小趋势
利润目标: 5 ticks = 0.5日元/股
持仓时间: 10-30秒
成功率: 50%

日盈利 = 5 ticks × 100股 × 50次 × 50%
       = 25日元 × 50%
       = 12.5日元/天
```

### 优势
✅ 跟随趋势，收益可观
✅ 持仓时间短，风险小
✅ 技术指标清晰

### 风险
⚠️ 假突破频繁
⚠️ 震荡市频繁止损
⚠️ 依赖技术分析

---

## 策略3: 盘口统计订单流 (TapeReading)

### 核心思路
深度分析挂单厚度、大单、价格穿透力，判断方向。

### 适用场景
- **盘口清晰**: 深度数据完整
- **大单活跃**: 有主力资金
- **流动性好**: 挂单量充足

### 关键参数
```python
TapeReadingConfig(
    depth_levels=5,                     # 分析5档深度

    bid_ask_imbalance_threshold=0.6,    # 买卖不平衡60%
    large_order_threshold=500,          # 500股算大单
    penetration_ratio_threshold=0.7,    # 穿透力70%

    min_volume_for_signal=1000,         # 最小成交量1000股
    time_stop_seconds=20,               # 20秒时间止损
)
```

### 工作流程
1. **采集盘口数据**
   ```
   Bids:                    Asks:
   1000.5 (500股)           1001.0 (300股)
   1000.4 (600股)           1001.1 (400股)
   1000.3 (700股)           1001.2 (350股)
   1000.2 (550股)           1001.3 (450股)
   1000.1 (800股)           1001.4 (500股)
   ```

2. **计算指标**

   **买卖不平衡度**:
   ```
   总买方挂单 = 500+600+700+550+800 = 3150
   总卖方挂单 = 300+400+350+450+500 = 2000

   不平衡度 = (3150 - 2000) / (3150 + 2000)
           = 1150 / 5150
           = 0.223 (22.3%)
   ```

   **大单统计** (5秒窗口):
   ```
   买方大单: 3笔 × 500股
   卖方大单: 1笔 × 500股

   → 买方占优
   ```

   **价格穿透力**:
   ```
   最近10个价格变动:
   ↑↑↑↓↑↑↑↑↓↑

   向上: 7次
   向下: 3次

   向上穿透力 = 7/10 = 0.7 (70%)
   ```

3. **入场信号**

   **做多**:
   ```
   1. 买盘厚度优势 (不平衡≥60%)
   2. 买方大单多于卖方
   3. 价格向上穿透力≥70%
   4. 成交量≥1000股
   ```

   **做空**: (相反)

4. **出场机制**
   - 动态止盈: 盈利≥3 ticks后回撤1.5 ticks
   - 时间止损: 20秒强制平仓

### 盈利逻辑
```
识别大单方向 → 跟随主力
利润目标: 5 ticks = 0.5日元/股
成功率: 60% (大单准确率高)

日盈利 = 5 ticks × 100股 × 40次 × 60%
       = 20日元 × 60%
       = 12日元/天
```

### 优势
✅ 捕捉主力意图
✅ 信号质量高 (60%置信度)
✅ 盘口数据实时性强

### 风险
⚠️ 依赖盘口深度数据质量
⚠️ 大单可能是诱多/诱空
⚠️ 需要快速反应

---

## 6策略组合优势

### 1. 市场适应性强
- **震荡市** → 微网格发挥作用 (25%权重)
- **趋势市** → 动量跟随捕捉趋势 (20%权重)
- **全天候** → 做市+盘口统计持续运作

### 2. 风险分散
```
单策略最大亏损: 10万日元 → 自动禁用
总体止损: 50万日元/天

6个策略独立运作 → 不会同时触发止损
```

### 3. 动态权重调整
```
每50笔交易自动调整权重:
- 表现好的策略 → 增加权重
- 表现差的策略 → 降低权重
```

### 4. 盈利潜力
```
保守估算 (30%成功率):

微网格: 1,000日元/天
动量跟随: 12.5日元/天
盘口统计: 12日元/天
其他3策略: 15日元/天

总计: ~1,040日元/天 × 30% = 312日元/天
月盈利: 312 × 20交易日 = 6,240日元/月
```

**实际可能更高** (因为6个策略互补)

---

## 使用建议

### 短期 (1周)
1. ✅ **回测验证**
   - 使用历史数据测试
   - 调整参数优化
   - 确认盈利能力

2. ✅ **模拟盘测试**
   - 连接Kabu模拟环境
   - 观察各策略表现
   - 记录问题和改进点

### 中期 (1个月)
1. 📋 **小资金实盘**
   - 1万美元起步
   - 严格执行风控
   - 每日复盘

2. 📋 **参数调优**
   - 根据实际波动率调整
   - 优化网格间距
   - 调整EMA周期

### 长期 (3-6个月)
1. 📋 **扩大资金规模**
   - 逐步增加到10万美元
   - 保持风控纪律
   - 稳定盈利

2. 📋 **策略优化**
   - 机器学习调参
   - 新增策略
   - 降低延迟 (Rust重构)

---

## 风险警告

⚠️ **延迟问题**:
- 你的系统: 10-30ms
- 专业HFT: 0.5-2ms
- **建议**: 部署到东京云服务器

⚠️ **Kabu API限制**:
- 订单频率: ~10单/秒
- **建议**: 降低交易频率

⚠️ **手续费**:
- 每笔来回0.01% ≈ 0.1日元/股
- **建议**: 止盈目标≥3 ticks覆盖成本

⚠️ **市场风险**:
- 黑天鹅事件
- 流动性枯竭
- **建议**: 设置最大亏损限额

---

## 配置示例

```python
# main_v2.py

from integrated_trading_system_v2 import IntegratedTradingSystemV2

system = IntegratedTradingSystemV2(
    gateway=kabu_gateway,
    symbol="6425",  # 选择流动性好的标的
    tick_size=0.1,
)

# 启动系统
await system.start()
```

---

## 技术支持

**文档**:
- `BUG_FIX_SUMMARY.md` - BUG修复记录
- `DYNAMIC_EXIT_GUIDE.md` - 动态止盈详解
- `NEW_STRATEGIES_GUIDE.md` - 本文档

**测试**:
- `test_6_strategies.py` - 6策略系统测试
- `test_bug_fixes.py` - BUG修复验证

**联系**:
- GitHub: https://github.com/nietianqi/jp_hft_ai

---

**祝交易顺利！**
