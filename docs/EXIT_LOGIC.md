# 双引擎策略 - 止盈与网格卖出逻辑说明

## 📋 核心区别

| 操作 | 触发条件 | 卖出数量 | 目的 | 优先级 |
|------|---------|---------|------|--------|
| **止盈平仓** | 达到止盈条件 | **全部持仓** | 保护利润，完全退出 | ✅ 优先级1 |
| **网格卖出** | 价格上涨到网格层 | **一格数量** | 减仓盈利，继续持仓 | 优先级4 |

---

## 🎯 止盈逻辑（平仓操作）

### 触发条件

**三种止盈模式**（配置项选择）：

#### 1. 动态止盈（推荐）
```python
enable_dynamic_exit = True
```

**规则:**
```
if 盈利 >= dynamic_profit_threshold_ticks (0.5跳):
    if 从最高价回撤 >= dynamic_reversal_ticks (0.3跳):
        → 平仓全部持仓 ✅
    else:
        → 继续持有（让利润奔跑）
else:
    → 等待反转（亏损不止损）
```

**示例:**
```
持仓: 1500股
成本价: 1500
当前价: 1502.5 → 盈利 25跳 ✓
最高价: 1502.5
当前价: 1502.2 → 回撤 0.3跳 ✓
→ 触发动态止盈，平仓 1500股（全部）
```

---

#### 2. 移动止盈
```python
enable_dynamic_exit = False
enable_trailing_stop = True
```

**规则:**
```
if 盈利 >= trailing_activation_ticks (3跳):
    激活移动止盈
    if 从激活后最高价回撤 >= trailing_distance_ticks (2跳):
        → 平仓全部持仓 ✅
```

**示例:**
```
持仓: 1200股
成本价: 1500
当前价: 1503 → 盈利 30跳，激活移动止盈 ✓
最高价: 1504 → 继续上涨
当前价: 1503.8 → 回撤 2跳 ✓
→ 触发移动止盈，平仓 1200股（全部）
```

---

#### 3. 固定止盈
```python
enable_dynamic_exit = False
enable_trailing_stop = False
```

**规则:**
```
if 盈利 >= profit_take_pct (0.5%):
    → 平仓全部持仓 ✅
```

**示例:**
```
持仓: 1000股
成本价: 1500
当前价: 1507.5 → 盈利 0.5% ✓
→ 触发固定止盈，平仓 1000股（全部）
```

---

### 代码实现

**关键代码片段:**
```python
# dual_engine_strategy.py:604
signal = TradingSignal(
    symbol=tick.symbol,
    action=1,  # SELL
    price=price,
    quantity=st.position,  # ✅ 关键：卖出全部持仓
    confidence=0.9,
    reason="dynamic_exit_reversal"  # 或 "trailing_stop" 或 "take_profit"
)
```

**日志输出:**
```
[DualEngine][Exit] 动态止盈触发：平仓 1500 股, profit=25.0T, reversal=0.3T, cost=1500.00, price=1502.20
[DualEngine][Exit] 移动止盈触发：平仓 1200 股, pullback=2.0T, best=1504.00, current=1503.80
[DualEngine][Exit] 固定止盈触发：平仓 1000 股, profit=50.0T, cost=1500.00, price=1507.50
```

---

## 🕸️ 网格卖出逻辑（减仓操作）

### 触发条件

**网格卖出** 在价格上涨时逐步减仓：

```python
# 条件1: 价格高于网格中心
price > grid_center

# 条件2: 持仓足够
position >= grid_volume (100股)

# 条件3: 达到最低卖价（成本价 + 手续费 + 利润）
price >= avg_cost_price + fee_cost_per_share

# 条件4: 接近网格层价格
abs(price - grid_layer_price) / price < step * 0.5
```

### 卖出数量

**关键差异:**
```python
# dual_engine_strategy.py:540
signal = TradingSignal(
    symbol=tick.symbol,
    action=1,  # SELL
    price=price,
    quantity=self.cfg.grid_volume,  # ✅ 只卖一格（100股），不是全部
    confidence=0.6,
    reason="grid_sell_L1"
)
```

### 示例

```
持仓: 1500股
网格中心: 1500
网格步长: 0.3%
每格数量: 100股
成本价: 1499

网格层级:
L1: 1500 × (1 + 0.3%) = 1504.5
L2: 1500 × (1 + 0.6%) = 1509.0
L3: 1500 × (1 + 0.9%) = 1513.5

价格上涨:
1504.5 → 网格卖出 100股（剩余 1400股）
1509.0 → 网格卖出 100股（剩余 1300股）
1513.5 → 网格卖出 100股（剩余 1200股）
...继续持有 1200股
```

**日志输出:**
```
[DualEngine][Grid] 网格减仓信号：卖出 100 股 (持仓 1500), 价格=1504.50, 最低卖价=1500.32
```

---

## 🔄 执行优先级

**`generate_signal()` 方法的逻辑顺序：**

```python
1. 优先级1: 止盈检查（平仓全部持仓）
   ↓ 如果触发止盈 → 返回平仓信号
   ↓ 如果没有触发 → 继续

2. 优先级2: 趋势检查
   ↓ 如果趋势失效 → 返回 None（不开新仓）
   ↓ 如果趋势成立 → 继续

3. 优先级3: 核心仓检查
   ↓ 如果仓位 < 核心仓位 → 返回补仓信号
   ↓ 如果已达核心仓位 → 继续

4. 优先级4: 网格检查
   ↓ 价格低于中心 → 网格买入信号
   ↓ 价格高于中心 → 网格卖出信号（只卖一格）
```

**示例场景:**

| 场景 | 持仓 | 盈利 | 价格 | 执行操作 |
|------|------|------|------|----------|
| 达到止盈 | 1500股 | 25跳 | 1502 | ✅ 平仓 1500股 |
| 趋势成立，仓位不足 | 800股 | -10跳 | 1495 | 补仓 200股 → 1000股 |
| 价格上涨，网格卖出 | 1200股 | 5跳 | 1504 | 网格卖出 100股 → 1100股 |
| 价格下跌，网格买入 | 1000股 | -5跳 | 1495 | 网格买入 100股 → 1100股 |

---

## 💡 关键设计理念

### 为什么止盈要平仓全部？

1. **保护利润** - 趋势可能反转，一次性锁定全部利润
2. **简化管理** - 清空仓位后重新开始，避免复杂的仓位状态
3. **风险控制** - 盈利后退出，降低回撤风险

### 为什么网格只卖一格？

1. **持续盈利** - 趋势持续时继续持有，最大化收益
2. **风险对冲** - 价格波动时通过网格平滑盈亏
3. **成本优化** - 逐步降低持仓成本，提高安全边际

---

## 🔧 配置建议

### 激进配置（追求利润最大化）

```python
dual_engine: DualEngineConfig(
    enable_dynamic_exit=True,            # 启用动态止盈
    dynamic_profit_threshold_ticks=0.3,  # 降低盈利阈值
    dynamic_reversal_ticks=0.5,          # 提高反转阈值（更难触发）
    grid_step_pct=0.2,                   # 缩小网格步长（更密集）
)
```

**效果:** 让利润充分奔跑，不轻易止盈

---

### 稳健配置（保护利润）

```python
dual_engine: DualEngineConfig(
    enable_dynamic_exit=False,           # 关闭动态止盈
    enable_trailing_stop=True,           # 使用移动止盈
    trailing_activation_ticks=2,         # 降低激活阈值
    trailing_distance_ticks=1,           # 缩小回撤阈值（更快触发）
    grid_step_pct=0.5,                   # 放大网格步长
)
```

**效果:** 快速锁定利润，避免回撤

---

## 📊 实战示例

### 场景1: 趋势启动 → 持有 → 反转止盈

```
时间轴:
10:00 - 价格 1500，趋势成立 → 买入 1000股（核心仓）
10:05 - 价格 1495 → 网格买入 100股（总 1100股）
10:10 - 价格 1490 → 网格买入 100股（总 1200股）
10:15 - 价格 1495 → 回调，继续持有
10:20 - 价格 1505 → 网格卖出 100股（总 1100股），盈利 5跳
10:25 - 价格 1510 → 网格卖出 100股（总 1000股），盈利 10跳
10:30 - 价格 1515 → 最高价，盈利 15跳，继续持有
10:35 - 价格 1514.7 → 回撤 0.3跳 ✓
→ 触发动态止盈，平仓 1000股（全部）
→ 实现盈利: (1514.7 - 成本价) × 1000股
```

**成本价计算:**
```
总买入金额 = 1000×1500 + 100×1495 + 100×1490 = 1,798,500
总买入数量 = 1000 + 100 + 100 = 1200
平均成本价 = 1,798,500 / 1200 = 1498.75

网格卖出后:
剩余金额 = 1,798,500 - 100×1498.75 - 100×1498.75 = 1,498,750
剩余数量 = 1200 - 100 - 100 = 1000
新成本价 = 1,498,750 / 1000 = 1498.75（保持不变）

最终盈利 = (1514.7 - 1498.75) × 1000 = 15,950 JPY
```

---

## ⚠️ 注意事项

1. **止盈优先** - 止盈检查在网格之前，确保利润优先保护
2. **仓位检查** - 网格卖出前检查 `position >= grid_volume`
3. **成本价过滤** - 网格卖出必须高于成本价 + 手续费
4. **日志监控** - 观察日志区分止盈和网格卖出
5. **参数调优** - 根据市场波动调整止盈参数

---

**文档版本:** v1.0
**更新时间:** 2025-12-03
**相关文件:** `strategy/original/dual_engine_strategy.py`
