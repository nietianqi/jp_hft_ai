# 部署指南

## ⚠️ 严重警告

**这是修复版本，但仍需谨慎！**

本系统包含以下关键修复:
1. Bid/Ask定义修复
2. 订单流策略替换
3. 信用交易参数修复
4. Import路径修复
5. Async/Await统一

但是:**尚未在真实环境充分测试！**

## 📋 部署前检查清单

### 必须完成的检查

- [ ] 已仔细阅读README.md中的所有警告
- [ ] 已理解Bid/Ask转换逻辑
- [ ] 已确认信用交易参数正确
- [ ] 已运行模拟测试并观察结果
- [ ] 已准备好随时手动干预
- [ ] 已设置Kabu Station自动止损
- [ ] 已准备只用测试资金

### 配置检查

- [ ] `config/system_config.py`中API密码已修改
- [ ] 仓位参数已调整为测试规模(100股)
- [ ] 止损参数已设置为保守值
- [ ] 已了解每个策略的运作方式

## 🚀 部署步骤

### 阶段1: 本地模拟测试 (1-2天)

```bash
# 运行主程序
python main.py

# 观察输出:
# - 策略是否正常产生信号
# - 仓位是否在限制内
# - 止损是否正确触发
# - 权重是否动态调整
```

**预期结果**:
- 程序正常运行无崩溃
- 策略产生合理信号
- 风控正确触发

### 阶段2: API连接测试 (半天)

```bash
# 确保Kabu Station已启动
# localhost:18080

# 测试API连接
python -c "
import httpx
resp = httpx.post('http://localhost:18080/kabusapi/token', 
                  json={'APIPassword': 'your_password'})
print(resp.status_code)
"
```

**预期结果**: 返回200

### 阶段3: 小仓位实盘测试 (1周)

**配置调整**:
```python
# config/strategy_config.py
max_total_position = 100  # 仅100股
take_profit_ticks = 3     # 保守止盈
stop_loss_ticks = 50      # 紧止损
```

**监控要点**:
1. **订单方向**: 确认买/卖方向正确
2. **成交价格**: 确认价格在合理范围
3. **仓位控制**: 确认不超过100股
4. **止损触发**: 确认亏损50 ticks时止损
5. **盈利保护**: 确认盈利时正确平仓

**每日检查**:
- 早盘: 检查系统状态和持仓
- 盘中: 每小时检查一次
- 收盘: 确认所有仓位已平

**出现以下情况立即停止**:
- 订单方向错误
- 仓位失控
- 止损未触发
- 频繁拒单
- 资金异常变化

### 阶段4: 逐步放大 (如果阶段3稳定)

**第2周**: 200股
**第3周**: 300股
**第4周**: 400股

每次放大前确认:
- 上周盈利或小幅亏损
- 未出现技术故障
- 风控正常触发
- 策略表现符合预期

## 🛡️ 风险管理

### 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| Bid/Ask仍有问题 | 低 | 严重 | 小仓位测试,手动验证 |
| Kabu API不稳定 | 中 | 严重 | 设置超时,异常处理 |
| 网络延迟 | 高 | 中 | 本地部署,专线 |
| 系统崩溃 | 低 | 严重 | 设置自动重启 |

### 市场风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 剧烈波动 | 中 | 严重 | 扩大止损,暂停交易 |
| 流动性不足 | 中 | 中 | 选择活跃标的 |
| 停牌 | 低 | 严重 | 手动平仓 |

### 策略风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| 参数未优化 | 高 | 中 | 持续回测调整 |
| 过度交易 | 中 | 中 | 限制交易次数 |
| 策略失效 | 中 | 严重 | 多策略分散 |

## 🆘 应急预案

### 场景1: 订单方向错误

**症状**: 想买时系统在卖
**原因**: Bid/Ask转换仍有问题
**处理**:
1. 立即停止程序
2. 手动平掉所有仓位
3. 检查`kabu_data_converter_fixed.py`
4. 不要继续交易直到修复

### 场景2: 无法平仓

**症状**: 平仓指令未执行
**原因**: API异常或仓位状态错误
**处理**:
1. 不要重复发送平仓指令
2. 直接在Kabu Station手动平仓
3. 停止程序
4. 检查日志

### 场景3: 仓位失控

**症状**: 仓位超过限制
**原因**: 风控逻辑失效
**处理**:
1. 在Kabu Station查看实际仓位
2. 手动平掉超额部分
3. 停止程序
4. 修复风控逻辑

### 场景4: 频繁亏损

**症状**: 连续10笔以上亏损
**原因**: 市场环境不适合或参数不当
**处理**:
1. 暂停交易
2. 分析亏损原因
3. 调整参数或暂停该策略
4. 不要急于翻本

## 📊 监控指标

### 每小时检查

- 当前仓位 vs 限制
- 未实现盈亏
- 挂单数量
- 成交价格合理性

### 每日检查

- 已实现盈亏
- 交易次数
- 胜率
- 最大回撤
- 是否触发风控

### 每周检查

- 累计盈亏
- 各策略表现
- 参数是否需要调整
- 系统稳定性

## 🎯 性能预期

### 保守估计 (测试期)

- 日均交易: 10-30笔
- 日均盈亏: -2万到+5万日元
- 胜率: 35-55%
- 最大回撤: -10万到-30万日元

### 乐观估计 (稳定期)

- 日均交易: 30-50笔
- 日均盈亏: -1万到+10万日元
- 胜率: 45-60%
- 最大回撤: -20万到-50万日元

**注意**: 前期大概率亏损，需至少1个月数据判断有效性

## 📝 日志记录

建议记录:
- 每日交易记录
- 异常事件
- 参数调整历史
- 市场环境笔记

## ✅ 成功标准

### 短期 (1个月)

- 系统稳定运行无崩溃
- 未出现重大技术故障
- 风控正确触发
- 亏损在可接受范围内

### 中期 (3个月)

- 累计盈利或小幅亏损
- 夏普比率 > 0
- 最大回撤 < 总资金10%
- 各策略权重趋于稳定

### 长期 (6个月+)

- 稳定盈利
- 夏普比率 > 1
- 可考虑放大资金

## 🚫 何时应该停止

立即停止交易如果:
- 连续3天大幅亏损(>日亏损限额)
- 出现无法解释的技术故障
- 市场环境发生根本变化
- 心理压力过大影响判断

## 📞 技术支持

所有代码都有详细注释:
- `utils/kabu_data_converter_fixed.py` - 数据转换
- `execution/kabu_executor.py` - 订单执行
- `engine/meta_strategy_manager.py` - 风控逻辑

遇到问题时:
1. 检查日志文件
2. 查看代码注释
3. 回顾README警告
4. 考虑暂停交易

---

**最重要的: 不要急于实盘，充分测试，小仓位开始！** 🚨
